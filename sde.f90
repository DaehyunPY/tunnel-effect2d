module sde
	implicit none





contains

! d/dx y(x) = f(x, y)

subroutine rk4_vec(f_vec, dx, x, y)	
	interface
		function f_vec(x, y) result(result)
			double precision, intent(in) :: x
			complex(kind(0.d0)), intent(in) :: y(1:2)
			complex(kind(0.d0)) :: result(1:size(y(1:)))
		end function
	end interface
	double precision, intent(in) :: dx, x
	complex(kind(0.d0)), intent(inout) :: y(1:)
	complex(kind(0.d0)) :: tmp(1:size(y(1:))), k(1:size(y(1:)), 1:4)

	tmp(:) = y(:)

		k(:, 1) = f_vec(x,             tmp(:))
		k(:, 2) = f_vec(x    +dx/2.d0, tmp(:) +dx/2.d0*k(:, 1))
		k(:, 3) = f_vec(x    +dx/2.d0, tmp(:) +dx/2.d0*k(:, 2))
		k(:, 4) = f_vec(x    +dx,      tmp(:) +dx     *k(:, 3))

		y(:) = tmp(:) +dx*(  1.d0/6.d0*k(:, 1) &
							+2.d0/6.d0*k(:, 2) &
							+2.d0/6.d0*k(:, 3) &
							+1.d0/6.d0*k(:, 4))
		
end subroutine rk4_vec





subroutine rk4_mat(f_mat, dx, x, y)	
	interface
		function f_mat(x, y) result(result)
			double precision, intent(in) :: x
			complex(kind(0.d0)), intent(in) :: y(1:, 1:)
			complex(kind(0.d0)) :: result(1:size(y(1:, 1)), 1:size(y(1, 1:)))
		end function
	end interface
	double precision, intent(in) :: dx, x
	complex(kind(0.d0)), intent(inout) :: y(1:, 1:)
	complex(kind(0.d0)) :: tmp(1:size(y(1:, 1)), 1:size(y(1, 1:))), k(1:size(y(1:, 1)), 1:size(y(1, 1:)), 1:13)

	tmp(:, :) = y(:, :)

		k(:, :, 1) = f_mat(x,             tmp(:, :))
		k(:, :, 2) = f_mat(x    +dx/2.d0, tmp(:, :) +dx/2.d0*k(:, :, 1))
		k(:, :, 3) = f_mat(x    +dx/2.d0, tmp(:, :) +dx/2.d0*k(:, :, 2))
		k(:, :, 4) = f_mat(x    +dx,      tmp(:, :) +dx     *k(:, :, 3))

		y(:, :) = tmp(:, :) +dx*(	 1.d0/6.d0*k(:, :, 1) &
									+2.d0/6.d0*k(:, :, 2) &
									+2.d0/6.d0*k(:, :, 3) &
									+1.d0/6.d0*k(:, :, 4))

end subroutine rk4_mat




















subroutine rk5_mat(f_mat, dx, x, y)	
	interface
		function f_mat(x, y) result(result)
			double precision, intent(in) :: x
			complex(kind(0.d0)), intent(in) :: y(1:, 1:)
			complex(kind(0.d0)) :: result(1:size(y(1:, 1)), 1:size(y(1, 1:)))
		end function
	end interface
	double precision, intent(in) :: dx, x
	complex(kind(0.d0)), intent(inout) :: y(1:, 1:)
	complex(kind(0.d0)) :: tmp(1:size(y(1:, 1)), 1:size(y(1, 1:))), k(1:size(y(1:, 1)), 1:size(y(1, 1:)), 1:6)

	tmp(:, :) = y(:, :)

		k(:, :, 1) = f_mat(x, tmp(:, :))
		k(:, :, 2) = f_mat(x 	+dx*1.d0/4.d0, tmp(:, :) &
								+dx*1.d0/4.d0*k(:, :, 1))
		k(:, :, 3) = f_mat(x 	+dx*3.d0/8.d0, tmp(:, :) &	
								+dx*3.d0/32.d0*k(:, :, 1) &
								+dx*9.d0/32.d0*k(:, :, 2))
		k(:, :, 4) = f_mat(x 	+dx*12.d0/13.d0, tmp(:, :) &
								+dx*1932.d0/2197.d0*k(:, :, 1) &
								-dx*7200.d0/2197.d0*k(:, :, 2) &
								+dx*7296.d0/2197.d0*k(:, :, 3))
		k(:, :, 5) = f_mat(x 	+dx*1.d0, tmp(:, :) &
								+dx*439.d0/216.d0*k(:, :, 1) &
								-dx*8.d0*k(:, :, 2) &
								+dx*3680.d0/513.d0*k(:, :, 3) &
								-dx*845.d0/4104.d0*k(:, :, 4))
		k(:, :, 6) = f_mat(x 	+dx*1.d0/2.d0, tmp(:, :) &
								-dx*8.d0/27.d0*k(:, :, 1) &
								+dx*2.d0*k(:, :, 2) &
								-dx*3544.d0/2565.d0*k(:, :, 3) &
								+dx*1859.d0/4104.d0*k(:, :, 4) &
								-dx*11.d0/40.d0*k(:, :, 5))

		y(:, :) = tmp(:, :) +dx*(	+16.d0/135.d0*k(:, :, 1) &
									+6656.d0/12825.d0*k(:, :, 3) &
									+28561.d0/56430.d0*k(:, :, 4) &
									-9.d0/50.d0*k(:, :, 5) &
									+2.d0/55.d0*k(:, :, 6))

! 		y(:, :) = tmp(:, :) +dx*(	+25.d0/216.d0*k(:, :, 1) &
! 									+1408.d0/2565.d0*k(:, :, 3) &
! 									+2197.d0/4104.d0*k(:, :, 4) &
! 									-1.d0/5.d0*k(:, :, 5))

end subroutine rk5_mat




















subroutine rk6_mat(f_mat, dx, x, y)	
	interface
		function f_mat(x, y) result(result)
			double precision, intent(in) :: x
			complex(kind(0.d0)), intent(in) :: y(1:, 1:)
			complex(kind(0.d0)) :: result(1:size(y(1:, 1)), 1:size(y(1, 1:)))
		end function
	end interface
	double precision, intent(in) :: dx, x
	complex(kind(0.d0)), intent(inout) :: y(1:, 1:)
	complex(kind(0.d0)) :: tmp(1:size(y(1:, 1)), 1:size(y(1, 1:))), k(1:size(y(1:, 1)), 1:size(y(1, 1:)), 1:8)

	tmp(:, :) = y(:, :)

		k(:, :, 1) = f_mat(x, tmp(:, :))
		k(:, :, 2) = f_mat(x 	+dx*1.d0/10.d0, tmp(:, :) &
								+dx*1.d0/10.d0*k(:, :, 1))
		k(:, :, 3) = f_mat(x 	+dx*2.d0/9.d0, tmp(:, :) &	
								-dx*2.d0/81.d0*k(:, :, 1) &
								+dx*20.d0/81.d0*k(:, :, 2))
		k(:, :, 4) = f_mat(x 	+dx*3.d0/7.d0, tmp(:, :) &
								+dx*615.d0/1372.d0*k(:, :, 1) &
								-dx*270.d0/343.d0*k(:, :, 2) &
								+dx*1053.d0/1372.d0*k(:, :, 3))
		k(:, :, 5) = f_mat(x 	+dx*3.d0/5.d0, tmp(:, :) &
								+dx*3243.d0/5500.d0*k(:, :, 1) &
								-dx*54.d0/55.d0*k(:, :, 2) &
								+dx*50949.d0/71500.d0*k(:, :, 3) &
								+dx*4998.d0/17875.d0*k(:, :, 4))
		k(:, :, 6) = f_mat(x 	+dx*4.d0/5.d0, tmp(:, :) &
								-dx*26492.d0/37125.d0*k(:, :, 1) &
								+dx*72.d0/55.d0*k(:, :, 2) &
								+dx*2808.d0/23375.d0*k(:, :, 3) &
								-dx*24206.d0/37125.d0*k(:, :, 4) &
								+dx*338.d0/459.d0*k(:, :, 5))
		k(:, :, 7) = f_mat(x 	+dx*1.d0, tmp(:, :) &
								+dx*5561.d0/2376.d0*k(:, :, 1) &
								-dx*35.d0/11.d0*k(:, :, 2) &
								-dx*24117.d0/31603.d0*k(:, :, 3) &
								+dx*899983.d0/200772.d0*k(:, :, 4) &
								-dx*5225.d0/1836.d0*k(:, :, 5) &
								+dx*3925.d0/4056.d0*k(:, :, 6))
		k(:, :, 8) = f_mat(x 	+dx*1.d0, tmp(:, :) &
								+dx*465467.d0/266112.d0*k(:, :, 1) &
								-dx*2945.d0/1232.d0*k(:, :, 2) &
								-dx*5610201.d0/14158144.d0*k(:, :, 3) &
								+dx*10513573.d0/3212352.d0*k(:, :, 4) &
								-dx*424325.d0/205632.d0*k(:, :, 5) &
								+dx*376225.d0/454272.d0*k(:, :, 6))

		y(:, :) = tmp(:, :) +dx*(	+61.d0/864.d0*k(:, :, 1) &
									+98415.d0/321776.d0*k(:, :, 3) &
									+16807.d0/146016.d0*k(:, :, 4) &
									+1375.d0/7344.d0*k(:, :, 5) &
									+1375.d0/5408.d0*k(:, :, 6) &
									-37.d0/1120.d0*k(:, :, 7) &
									+1.d0/10.d0*k(:, :, 8))

! 		y(:, :) = tmp(:, :) +dx*(	+821.d0/10800.d0*k(:, :, 1) &
! 									+19683.d0/71825.d0*k(:, :, 3) &
! 									+175273.d0/912600.d0*k(:, :, 4) &
! 									+395.d0/3672.d0*k(:, :, 5) &
! 									+785.d0/2704.d0*k(:, :, 6) &
! 									+3.d0/50.d0*k(:, :, 7))

end subroutine rk6_mat




















subroutine rk8_vec(f_vec, dx, x, y)	
	interface
		function f_vec(x, y) result(result)
			double precision, intent(in) :: x
			complex(kind(0.d0)), intent(in) :: y(1:2)
			complex(kind(0.d0)) :: result(1:size(y(1:)))
		end function
	end interface
	double precision, intent(in) :: dx, x
	complex(kind(0.d0)), intent(inout) :: y(1:)
	complex(kind(0.d0)) :: tmp(1:size(y(1:))), k(1:size(y(1:)), 1:13)

	! kokokara syuusei
	tmp(:) = y(:)

		k(:, 1) = f_vec(x, tmp(:))
		k(:, 2) = f_vec(x 	+dx*1.d0/18.d0, tmp(:) &
								+dx*1.d0/18.d0*k(:, 1))
		k(:, 3) = f_vec(x 	+dx*1.d0/12.d0, tmp(:) &
								+dx*1.d0/48.d0*k(:, 1) &
								+dx*1.d0/16.d0*k(:, 2))
		k(:, 4) = f_vec(x 	+dx*1.d0/8.d0, tmp(:) &
								+dx*1.d0/32.d0*k(:, 1) &
								+dx*3.d0/32.d0*k(:, 3))
		k(:, 5) = f_vec(x 	+dx*5.d0/16.d0, tmp(:) &
								+dx*5.d0/16.d0*k(:, 1) &
								-dx*75.d0/64.d0*k(:, 3) &
								+dx*75.d0/64.d0*k(:, 4))
		k(:, 6) = f_vec(x 	+dx*3.d0/8.d0, tmp(:) &
								+dx*3.d0/80.d0*k(:, 1) &
								+dx*3.d0/16.d0*k(:, 4) &
								+dx*3.d0/20.d0*k(:, 5))
		k(:, 7) = f_vec(x 	+dx*59.d0/400.d0, tmp(:) & 
								+dx*29443841.d0/614563906.d0*k(:, 1) &
								+dx*77736538.d0/692538347.d0*k(:, 4) &
								-dx*28693883.d0/1125000000.d0*k(:, 5) &
								+dx*23124283.d0/1800000000.d0*k(:, 6))
		k(:, 8) = f_vec(x 	+dx*93.d0/200.d0, tmp(:) & 
								+dx*16016141.d0/946692911.d0*k(:, 1) &
								+dx*61564180.d0/158732637.d0*k(:, 4) &
								+dx*22789713.d0/633445777.d0*k(:, 5) &
								+dx*545815736.d0/2771057229.d0*k(:, 6) &
								-dx*180193667.d0/1043307555.d0*k(:, 7))
		k(:, 9) = f_vec(x 	+dx*5490023248.d0/9719169821.d0, tmp(:) & 
								+dx*39632708.d0/573591083.d0*k(:, 1) &
								-dx*433636366.d0/683701615.d0*k(:, 4) &
								-dx*421739975.d0/2616292301.d0*k(:, 5) &
								+dx*100302831.d0/723423059.d0*k(:, 6) &
								+dx*790204164.d0/839813087.d0*k(:, 7) &
								+dx*800635310.d0/3783071287.d0*k(:, 8))
		k(:, 10) = f_vec(x 	+dx*13.d0/20.d0, tmp(:) & 
								+dx*246121993.d0/1340847787.d0*k(:, 1) &
								-dx*37695042795.d0/15268766246.d0*k(:, 4) &
								-dx*309121744.d0/1061227803.d0*k(:, 5) &
								-dx*12992083.d0/490766935.d0*k(:, 6) &
								+dx*6005943493.d0/2108947869.d0*k(:, 7) &
								+dx*393006217.d0/1396673457.d0*k(:, 8) &
								+dx*123872331.d0/1001029789.d0*k(:, 9))
		k(:, 11) = f_vec(x 	+dx*1201146811.d0/1299019798.d0, tmp(:) & 
								-dx*1028468189.d0/846180014.d0*k(:, 1) &
								+dx*8478235783.d0/508512852.d0*k(:, 4) &
								+dx*1311729495.d0/1432422823.d0*k(:, 5) &
								-dx*10304129995.d0/1701304382.d0*k(:, 6) &
								-dx*48777925059.d0/3047939560.d0*k(:, 7) &
								+dx*15336726248.d0/1032824649.d0*k(:, 8) &
								-dx*45442868181.d0/3398467696.d0*k(:, 9) &
								+dx*3065993473.d0/597172653.d0*k(:, 10))
		k(:, 12) = f_vec(x 	+dx*1.d0, tmp(:) & 
								+dx*185892177.d0/718116043.d0*k(:, 1) &
								-dx*3185094517.d0/667107341.d0*k(:, 4) &
								-dx*477755414.d0/1098053517.d0*k(:, 5) &
								-dx*703635378.d0/230739211.d0*k(:, 6) &
								+dx*5731566787.d0/1027545527.d0*k(:, 7) &
								+dx*5232866602.d0/850066563.d0*k(:, 8) &
								-dx*4093664535.d0/808688257.d0*k(:, 9) &
								+dx*3962137247.d0/1805957418.d0*k(:, 10) &
								+dx*65686358.d0/487910083.d0*k(:, 11))
		k(:, 13) = f_vec(x 	+dx*1.d0, tmp(:) & 
								+dx*403863854.d0/491063109.d0*k(:, 1) &
								-dx*5068492393.d0/434740067.d0*k(:, 4) &
								-dx*411421997.d0/543043805.d0*k(:, 5) &
								+dx*652783627.d0/914296604.d0*k(:, 6) &
								+dx*11173962825.d0/925320556.d0*k(:, 7) &
								-dx*13158990841.d0/6184727034.d0*k(:, 8) &
								+dx*3936647629.d0/1978049680.d0*k(:, 9) &
								-dx*160528059.d0/685178525.d0*k(:, 10) &
								+dx*248638103.d0/1413531060.d0*k(:, 11))

		y(:) = tmp(:) +dx*(	+14005451.d0/335480064.d0*k(:, 1) &
									-59238493.d0/1068277825.d0*k(:, 6) &
									+181606767.d0/758867731.d0*k(:, 7) &
									+561292985.d0/797845732.d0*k(:, 8) &
									-1041891430.d0/1371343529.d0*k(:, 9) &
									+760417239.d0/1151165299.d0*k(:, 10) &
									+118820643.d0/751138087.d0*k(:, 11) &
									-528747749.d0/2220607170.d0*k(:, 12) &
									+1.d0/4.d0*k(:, 13))

! 		y(:) = tmp(:) +dx*(	+13451932.d0/455176623.d0*k(:, 1) &
! 									-808719846.d0/976000145.d0*k(:, 6) &
! 									+1757004468.d0/5645159321.d0*k(:, 7) &
! 									+656045339.d0/265891186.d0*k(:, 8) &
! 									-3867574721.d0/1518517206.d0*k(:, 9) &
! 									+465885868.d0/322736535.d0*k(:, 10) &
! 									+53011238.d0/667516719.d0*k(:, 11) &
! 									+2.d0/45.d0*k(:, 12))

end subroutine rk8_vec





subroutine rk8_mat(f_mat, dx, x, y)	
	interface
		function f_mat(x, y) result(result)
			double precision, intent(in) :: x
			complex(kind(0.d0)), intent(in) :: y(1:, 1:)
			complex(kind(0.d0)) :: result(1:size(y(1:, 1)), 1:size(y(1, 1:)))
		end function
	end interface
	double precision, intent(in) :: dx, x
	complex(kind(0.d0)), intent(inout) :: y(1:, 1:)
	complex(kind(0.d0)) :: tmp(1:size(y(1:, 1)), 1:size(y(1, 1:))), k(1:size(y(1:, 1)), 1:size(y(1, 1:)), 1:13)

	tmp(:, :) = y(:, :)

		k(:, :, 1) = f_mat(x, tmp(:, :))
		k(:, :, 2) = f_mat(x 	+dx*1.d0/18.d0, tmp(:, :) &
								+dx*1.d0/18.d0*k(:, :, 1))
		k(:, :, 3) = f_mat(x 	+dx*1.d0/12.d0, tmp(:, :) &
								+dx*1.d0/48.d0*k(:, :, 1) &
								+dx*1.d0/16.d0*k(:, :, 2))
		k(:, :, 4) = f_mat(x 	+dx*1.d0/8.d0, tmp(:, :) &
								+dx*1.d0/32.d0*k(:, :, 1) &
								+dx*3.d0/32.d0*k(:, :, 3))
		k(:, :, 5) = f_mat(x 	+dx*5.d0/16.d0, tmp(:, :) &
								+dx*5.d0/16.d0*k(:, :, 1) &
								-dx*75.d0/64.d0*k(:, :, 3) &
								+dx*75.d0/64.d0*k(:, :, 4))
		k(:, :, 6) = f_mat(x 	+dx*3.d0/8.d0, tmp(:, :) &
								+dx*3.d0/80.d0*k(:, :, 1) &
								+dx*3.d0/16.d0*k(:, :, 4) &
								+dx*3.d0/20.d0*k(:, :, 5))
		k(:, :, 7) = f_mat(x 	+dx*59.d0/400.d0, tmp(:, :) & 
								+dx*29443841.d0/614563906.d0*k(:, :, 1) &
								+dx*77736538.d0/692538347.d0*k(:, :, 4) &
								-dx*28693883.d0/1125000000.d0*k(:, :, 5) &
								+dx*23124283.d0/1800000000.d0*k(:, :, 6))
		k(:, :, 8) = f_mat(x 	+dx*93.d0/200.d0, tmp(:, :) & 
								+dx*16016141.d0/946692911.d0*k(:, :, 1) &
								+dx*61564180.d0/158732637.d0*k(:, :, 4) &
								+dx*22789713.d0/633445777.d0*k(:, :, 5) &
								+dx*545815736.d0/2771057229.d0*k(:, :, 6) &
								-dx*180193667.d0/1043307555.d0*k(:, :, 7))
		k(:, :, 9) = f_mat(x 	+dx*5490023248.d0/9719169821.d0, tmp(:, :) & 
								+dx*39632708.d0/573591083.d0*k(:, :, 1) &
								-dx*433636366.d0/683701615.d0*k(:, :, 4) &
								-dx*421739975.d0/2616292301.d0*k(:, :, 5) &
								+dx*100302831.d0/723423059.d0*k(:, :, 6) &
								+dx*790204164.d0/839813087.d0*k(:, :, 7) &
								+dx*800635310.d0/3783071287.d0*k(:, :, 8))
		k(:, :, 10) = f_mat(x 	+dx*13.d0/20.d0, tmp(:, :) & 
								+dx*246121993.d0/1340847787.d0*k(:, :, 1) &
								-dx*37695042795.d0/15268766246.d0*k(:, :, 4) &
								-dx*309121744.d0/1061227803.d0*k(:, :, 5) &
								-dx*12992083.d0/490766935.d0*k(:, :, 6) &
								+dx*6005943493.d0/2108947869.d0*k(:, :, 7) &
								+dx*393006217.d0/1396673457.d0*k(:, :, 8) &
								+dx*123872331.d0/1001029789.d0*k(:, :, 9))
		k(:, :, 11) = f_mat(x 	+dx*1201146811.d0/1299019798.d0, tmp(:, :) & 
								-dx*1028468189.d0/846180014.d0*k(:, :, 1) &
								+dx*8478235783.d0/508512852.d0*k(:, :, 4) &
								+dx*1311729495.d0/1432422823.d0*k(:, :, 5) &
								-dx*10304129995.d0/1701304382.d0*k(:, :, 6) &
								-dx*48777925059.d0/3047939560.d0*k(:, :, 7) &
								+dx*15336726248.d0/1032824649.d0*k(:, :, 8) &
								-dx*45442868181.d0/3398467696.d0*k(:, :, 9) &
								+dx*3065993473.d0/597172653.d0*k(:, :, 10))
		k(:, :, 12) = f_mat(x 	+dx*1.d0, tmp(:, :) & 
								+dx*185892177.d0/718116043.d0*k(:, :, 1) &
								-dx*3185094517.d0/667107341.d0*k(:, :, 4) &
								-dx*477755414.d0/1098053517.d0*k(:, :, 5) &
								-dx*703635378.d0/230739211.d0*k(:, :, 6) &
								+dx*5731566787.d0/1027545527.d0*k(:, :, 7) &
								+dx*5232866602.d0/850066563.d0*k(:, :, 8) &
								-dx*4093664535.d0/808688257.d0*k(:, :, 9) &
								+dx*3962137247.d0/1805957418.d0*k(:, :, 10) &
								+dx*65686358.d0/487910083.d0*k(:, :, 11))
		k(:, :, 13) = f_mat(x 	+dx*1.d0, tmp(:, :) & 
								+dx*403863854.d0/491063109.d0*k(:, :, 1) &
								-dx*5068492393.d0/434740067.d0*k(:, :, 4) &
								-dx*411421997.d0/543043805.d0*k(:, :, 5) &
								+dx*652783627.d0/914296604.d0*k(:, :, 6) &
								+dx*11173962825.d0/925320556.d0*k(:, :, 7) &
								-dx*13158990841.d0/6184727034.d0*k(:, :, 8) &
								+dx*3936647629.d0/1978049680.d0*k(:, :, 9) &
								-dx*160528059.d0/685178525.d0*k(:, :, 10) &
								+dx*248638103.d0/1413531060.d0*k(:, :, 11))

		y(:, :) = tmp(:, :) +dx*(	+14005451.d0/335480064.d0*k(:, :, 1) &
									-59238493.d0/1068277825.d0*k(:, :, 6) &
									+181606767.d0/758867731.d0*k(:, :, 7) &
									+561292985.d0/797845732.d0*k(:, :, 8) &
									-1041891430.d0/1371343529.d0*k(:, :, 9) &
									+760417239.d0/1151165299.d0*k(:, :, 10) &
									+118820643.d0/751138087.d0*k(:, :, 11) &
									-528747749.d0/2220607170.d0*k(:, :, 12) &
									+1.d0/4.d0*k(:, :, 13))

! 		y(:, :) = tmp(:, :) +dx*(	+13451932.d0/455176623.d0*k(:, :, 1) &
! 									-808719846.d0/976000145.d0*k(:, :, 6) &
! 									+1757004468.d0/5645159321.d0*k(:, :, 7) &
! 									+656045339.d0/265891186.d0*k(:, :, 8) &
! 									-3867574721.d0/1518517206.d0*k(:, :, 9) &
! 									+465885868.d0/322736535.d0*k(:, :, 10) &
! 									+53011238.d0/667516719.d0*k(:, :, 11) &
! 									+2.d0/45.d0*k(:, :, 12))

end subroutine rk8_mat
end module sde